library(contextual)
library(here)
setwd(here("demo","replication_kruijswijk_2018"))

horizon        <- 10000
simulations    <- 100
subjects       <- list(50,100,500,1000)
betas          <- list(c(1.5, 1.5),c(5, 5))
do_poisson     <- list(FALSE,TRUE)
policies       <- list("EG","UCB","Thompson")
subpolicies    <- list("Partial", "Pooled", "Unpooled" )
data_dir       <- "./data/"

plot_log       <- History$new()

for (dp in do_poisson) {
  for (beta in betas)    {
    dev.hold()
    par(mfrow = c(length(subjects),length(policies)))
    par(oma = c(0.1,0.1,2,0.1))
    par(mar = c(0, 0, 0, 0))
    par(xaxt = "n")
    par(yaxt = "n")
    i <- 1
    for (sn in subjects)   {
      for (pol in policies)   {
        plot_log$clear_data_table()
        for (subpol in subpolicies)   {
          sim_str <- paste0(subpol,pol,"_b",beta[1],"_s",sn,"_p",as.numeric(dp), "_r",simulations,".RData")
          message(paste0("Plotting: ",sim_str))
          plot_log$load(paste0(data_dir,sim_str))
        }
        if (i == 1) { do_legend <- TRUE } else {do_legend <- FALSE }
        plot(plot_log, no_par = TRUE, type = "cumulative", rate = FALSE, legend = do_legend,
             legend_labels = subpolicies, legend_border = FALSE, ylim = c(1,1650))
        title(outer = FALSE, main = pol, adj = 0.96, line = -1.3,
              font.main = 1, cex.main = 1.0, col.main = "black")
        if (i > 1) {
          title(outer = FALSE, main = sn, adj = 0.04, line = -1.3,
                font.main = 1, cex.main = 1.0, col.main = "black")
        }
        i <- i + 1
      }
    }
    title(paste0("Betas: ", beta[1], " Poisson: ", dp), outer = TRUE)
    dev.flush()
  }
}
